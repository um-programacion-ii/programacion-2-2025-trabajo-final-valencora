{
	"info": {
		"_postman_id": "eventos-backend-api-tests-2025",
		"name": "Eventos Backend - API Tests",
		"description": "Colecci√≥n completa de pruebas para el backend de eventos. Incluye autenticaci√≥n, gesti√≥n de eventos, sesi√≥n de selecci√≥n, asientos, administraci√≥n e integraci√≥n con c√°tedra.",
		"schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
	},
	"item": [
		{
			"name": "1. Autenticaci√≥n",
			"item": [
				{
					"name": "Login Admin",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"pm.test(\"Status code is 200\", function () {",
									"    pm.response.to.have.status(200);",
									"});",
									"",
								"pm.test(\"Response has id_token\", function () {",
								"    var jsonData = pm.response.json();",
								"    pm.expect(jsonData).to.have.property('id_token');",
								"    ",
								"    // Guardar token en variable de entorno",
								"    var token = jsonData.id_token;",
								"    if (token && token.trim() !== '') {",
								"        pm.environment.set(\"admin_token\", token);",
								"        console.log(\"‚úÖ Token de admin guardado: \" + token.substring(0, 30) + \"...\");",
								"        console.log(\"‚úÖ Longitud del token: \" + token.length);",
								"    } else {",
								"        console.log(\"‚ùå Error: Token vac√≠o o inv√°lido\");",
								"    }",
								"});"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"auth": {
							"type": "noauth"
						},
						"method": "POST",
						"header": [
							{
								"key": "Content-Type",
								"value": "application/json"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "{\n  \"username\": \"{{admin_username}}\",\n  \"password\": \"{{admin_password}}\",\n  \"rememberMe\": true\n}"
						},
						"url": {
							"raw": "{{base_url}}/api/authenticate",
							"host": [
								"{{base_url}}"
							],
							"path": [
								"api",
								"authenticate"
							]
						},
						"description": "Inicia sesi√≥n con credenciales de administrador y guarda el token JWT en la variable de entorno."
					},
					"response": []
				},
				{
					"name": "Login User",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"pm.test(\"Status code is 200\", function () {",
									"    pm.response.to.have.status(200);",
									"});",
									"",
								"pm.test(\"Response has id_token\", function () {",
								"    var jsonData = pm.response.json();",
								"    pm.expect(jsonData).to.have.property('id_token');",
								"    ",
								"    // Guardar token en variable de entorno",
								"    var token = jsonData.id_token;",
								"    if (token && token.trim() !== '') {",
								"        pm.environment.set(\"user_token\", token);",
								"        console.log(\"‚úÖ Token de user guardado: \" + token.substring(0, 30) + \"...\");",
								"    } else {",
								"        console.log(\"‚ùå Error: Token vac√≠o o inv√°lido\");",
								"    }",
								"});"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"auth": {
							"type": "noauth"
						},
						"method": "POST",
						"header": [
							{
								"key": "Content-Type",
								"value": "application/json"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "{\n  \"username\": \"{{user_username}}\",\n  \"password\": \"{{user_password}}\",\n  \"rememberMe\": true\n}"
						},
						"url": {
							"raw": "{{base_url}}/api/authenticate",
							"host": [
								"{{base_url}}"
							],
							"path": [
								"api",
								"authenticate"
							]
						},
						"description": "Inicia sesi√≥n con credenciales de usuario normal y guarda el token JWT."
					},
					"response": []
				},
				{
					"name": "Get Account Info",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"pm.test(\"Status code is 200\", function () {",
									"    pm.response.to.have.status(200);",
									"});",
									"",
									"pm.test(\"Response has login\", function () {",
									"    var jsonData = pm.response.json();",
									"    pm.expect(jsonData).to.have.property('login');",
									"    console.log(\"Usuario autenticado:\", jsonData.login);",
									"});"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"auth": {
							"type": "bearer",
							"bearer": [
								{
									"key": "token",
									"value": "{{admin_token}}",
									"type": "string"
								}
							]
						},
						"method": "GET",
						"header": [],
						"url": {
							"raw": "{{base_url}}/api/account",
							"host": [
								"{{base_url}}"
							],
							"path": [
								"api",
								"account"
							]
						},
						"description": "Obtiene la informaci√≥n de la cuenta del usuario autenticado."
					},
					"response": []
				},
				{
					"name": "Logout",
					"request": {
						"auth": {
							"type": "bearer",
							"bearer": [
								{
									"key": "token",
									"value": "{{admin_token}}",
									"type": "string"
								}
							]
						},
						"method": "POST",
						"header": [],
						"url": {
							"raw": "{{base_url}}/api/logout",
							"host": [
								"{{base_url}}"
							],
							"path": [
								"api",
								"logout"
							]
						},
						"description": "Cierra la sesi√≥n del usuario autenticado."
					},
					"response": []
				}
			],
			"description": "Endpoints relacionados con autenticaci√≥n y gesti√≥n de sesi√≥n de usuarios."
		},
		{
			"name": "2. Eventos",
			"item": [
				{
					"name": "Listar Eventos Activos",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"pm.test(\"Status code is 200\", function () {",
									"    pm.response.to.have.status(200);",
									"});",
									"",
									"pm.test(\"Response is an array\", function () {",
									"    var jsonData = pm.response.json();",
									"    pm.expect(jsonData).to.be.an('array');",
									"});",
									"",
									"pm.test(\"Events are active (not cancelled)\", function () {",
									"    var jsonData = pm.response.json();",
									"    if (jsonData.length > 0) {",
									"        jsonData.forEach(function(evento) {",
									"            pm.expect(evento.cancelado).to.be.false;",
									"        });",
									"    }",
									"});",
									"",
					"// Guardar primer evento ID autom√°ticamente si existe",
					"var eventos = pm.response.json();",
					"if (eventos && eventos.length > 0) {",
					"    pm.environment.set(\"evento_id\", eventos[0].id);",
					"    console.log(\"‚úÖ Evento ID guardado autom√°ticamente:\", eventos[0].id);",
					"    console.log(\"üìã Total de eventos:\", eventos.length);",
					"} else {",
					"    console.log(\"‚ö†Ô∏è No hay eventos. Ejecuta 'Sincronizar Eventos desde C√°tedra' primero.\");",
					"}"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"auth": {
							"type": "bearer",
							"bearer": [
								{
									"key": "token",
									"value": "{{admin_token}}",
									"type": "string"
								}
							]
						},
						"method": "GET",
						"header": [],
						"url": {
							"raw": "{{base_url}}/api/eventos",
							"host": [
								"{{base_url}}"
							],
							"path": [
								"api",
								"eventos"
							]
						},
						"description": "Obtiene la lista de eventos activos (no cancelados y no expirados). Requiere autenticaci√≥n."
					},
					"response": []
				},
				{
					"name": "Obtener Detalle de Evento",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"pm.test(\"Status code is 200\", function () {",
									"    pm.response.to.have.status(200);",
									"});",
									"",
									"pm.test(\"Response has required fields\", function () {",
									"    var jsonData = pm.response.json();",
									"    pm.expect(jsonData).to.have.property('id');",
									"    pm.expect(jsonData).to.have.property('titulo');",
									"    pm.expect(jsonData).to.have.property('fecha');",
									"});"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"auth": {
							"type": "bearer",
							"bearer": [
								{
									"key": "token",
									"value": "{{admin_token}}",
									"type": "string"
								}
							]
						},
						"method": "GET",
						"header": [],
						"url": {
							"raw": "{{base_url}}/api/eventos/{{evento_id}}",
							"host": [
								"{{base_url}}"
							],
							"path": [
								"api",
								"eventos",
								"{{evento_id}}"
							]
						},
						"description": "Obtiene el detalle completo de un evento espec√≠fico por su ID."
					},
					"response": []
				},
				{
					"name": "Evento Inexistente (Error 404)",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"pm.test(\"Status code is 404\", function () {",
									"    pm.response.to.have.status(404);",
									"});"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"auth": {
							"type": "bearer",
							"bearer": [
								{
									"key": "token",
									"value": "{{admin_token}}",
									"type": "string"
								}
							]
						},
						"method": "GET",
						"header": [],
						"url": {
							"raw": "{{base_url}}/api/eventos/99999",
							"host": [
								"{{base_url}}"
							],
							"path": [
								"api",
								"eventos",
								"99999"
							]
						},
						"description": "Prueba de manejo de error cuando se solicita un evento que no existe."
					},
					"response": []
				},
				{
					"name": "Listar Eventos Sin Autenticaci√≥n (Error 401)",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"pm.test(\"Status code is 401\", function () {",
									"    pm.response.to.have.status(401);",
									"});"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "GET",
						"header": [],
						"url": {
							"raw": "{{base_url}}/api/eventos",
							"host": [
								"{{base_url}}"
							],
							"path": [
								"api",
								"eventos"
							]
						},
						"description": "Verifica que los endpoints de eventos requieren autenticaci√≥n."
					},
					"response": []
				}
			],
			"description": "Endpoints para consultar eventos. Solo lectura de eventos activos."
		},
		{
			"name": "3. Sesi√≥n de Selecci√≥n",
			"item": [
				{
					"name": "Obtener Estado de Sesi√≥n",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"pm.test(\"Status code is 200\", function () {",
									"    pm.response.to.have.status(200);",
									"});",
									"",
									"pm.test(\"Response is valid JSON\", function () {",
									"    var jsonData = pm.response.json();",
									"    pm.expect(jsonData).to.be.an('object');",
									"});"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"auth": {
							"type": "bearer",
							"bearer": [
								{
									"key": "token",
									"value": "{{admin_token}}",
									"type": "string"
								}
							]
						},
						"method": "GET",
						"header": [],
						"url": {
							"raw": "{{base_url}}/api/sesion/estado",
							"host": [
								"{{base_url}}"
							],
							"path": [
								"api",
								"sesion",
								"estado"
							]
						},
						"description": "Obtiene el estado actual de la sesi√≥n de selecci√≥n del usuario autenticado."
					},
					"response": []
				},
				{
					"name": "Actualizar Evento Seleccionado",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"pm.test(\"Status code is 204\", function () {",
									"    pm.response.to.have.status(204);",
									"});"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"auth": {
							"type": "bearer",
							"bearer": [
								{
									"key": "token",
									"value": "{{admin_token}}",
									"type": "string"
								}
							]
						},
						"method": "PUT",
						"header": [],
						"url": {
							"raw": "{{base_url}}/api/sesion/evento/{{evento_id}}",
							"host": [
								"{{base_url}}"
							],
							"path": [
								"api",
								"sesion",
								"evento",
								"{{evento_id}}"
							]
						},
						"description": "Actualiza el evento seleccionado en la sesi√≥n del usuario."
					},
					"response": []
				},
				{
					"name": "Actualizar Asientos Seleccionados",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"pm.test(\"Status code is 204\", function () {",
									"    pm.response.to.have.status(204);",
									"});"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"auth": {
							"type": "bearer",
							"bearer": [
								{
									"key": "token",
									"value": "{{admin_token}}",
									"type": "string"
								}
							]
						},
						"method": "PUT",
						"header": [
							{
								"key": "Content-Type",
								"value": "application/json"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "[\n  {\n    \"fila\": \"A\",\n    \"numero\": 1\n  },\n  {\n    \"fila\": \"A\",\n    \"numero\": 2\n  }\n]"
						},
						"url": {
							"raw": "{{base_url}}/api/sesion/asientos",
							"host": [
								"{{base_url}}"
							],
							"path": [
								"api",
								"sesion",
								"asientos"
							]
						},
						"description": "Actualiza los asientos seleccionados en la sesi√≥n del usuario."
					},
					"response": []
				},
				{
					"name": "Actualizar Nombres de Personas",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"pm.test(\"Status code is 204\", function () {",
									"    pm.response.to.have.status(204);",
									"});"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"auth": {
							"type": "bearer",
							"bearer": [
								{
									"key": "token",
									"value": "{{admin_token}}",
									"type": "string"
								}
							]
						},
						"method": "PUT",
						"header": [
							{
								"key": "Content-Type",
								"value": "application/json"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "{\n  \"A-1\": {\n    \"nombre\": \"Juan P√©rez\"\n  },\n  \"A-2\": {\n    \"nombre\": \"Mar√≠a Garc√≠a\"\n  }\n}"
						},
						"url": {
							"raw": "{{base_url}}/api/sesion/nombres",
							"host": [
								"{{base_url}}"
							],
							"path": [
								"api",
								"sesion",
								"nombres"
							]
						},
						"description": "Actualiza los nombres de las personas asociadas a los asientos seleccionados."
					},
					"response": []
				},
				{
					"name": "Guardar Estado Completo",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"pm.test(\"Status code is 204\", function () {",
									"    pm.response.to.have.status(204);",
									"});"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"auth": {
							"type": "bearer",
							"bearer": [
								{
									"key": "token",
									"value": "{{admin_token}}",
									"type": "string"
								}
							]
						},
						"method": "PUT",
						"header": [
							{
								"key": "Content-Type",
								"value": "application/json"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "{\n  \"eventoId\": {{evento_id}},\n  \"asientos\": [\n    {\n      \"fila\": \"A\",\n      \"numero\": 1\n    }\n  ],\n  \"nombres\": {\n    \"A-1\": {\n      \"nombre\": \"Juan P√©rez\"\n    }\n  }\n}"
						},
						"url": {
							"raw": "{{base_url}}/api/sesion/estado",
							"host": [
								"{{base_url}}"
							],
							"path": [
								"api",
								"sesion",
								"estado"
							]
						},
						"description": "Guarda el estado completo de la sesi√≥n (evento, asientos y nombres)."
					},
					"response": []
				},
				{
					"name": "Limpiar Estado de Sesi√≥n",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"pm.test(\"Status code is 204\", function () {",
									"    pm.response.to.have.status(204);",
									"});"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"auth": {
							"type": "bearer",
							"bearer": [
								{
									"key": "token",
									"value": "{{admin_token}}",
									"type": "string"
								}
							]
						},
						"method": "DELETE",
						"header": [],
						"url": {
							"raw": "{{base_url}}/api/sesion/estado",
							"host": [
								"{{base_url}}"
							],
							"path": [
								"api",
								"sesion",
								"estado"
							]
						},
						"description": "Elimina el estado de la sesi√≥n de selecci√≥n del usuario."
					},
					"response": []
				}
			],
			"description": "Endpoints para gestionar el estado de la sesi√≥n de selecci√≥n (evento, asientos, nombres)."
		},
		{
			"name": "4. Asientos",
			"item": [
				{
					"name": "Obtener Mapa de Asientos",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"pm.test(\"Status code is 200\", function () {",
									"    pm.response.to.have.status(200);",
									"});",
									"",
									"pm.test(\"Response has mapa structure\", function () {",
									"    var jsonData = pm.response.json();",
									"    pm.expect(jsonData).to.be.an('object');",
									"});"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"auth": {
							"type": "bearer",
							"bearer": [
								{
									"key": "token",
									"value": "{{admin_token}}",
									"type": "string"
								}
							]
						},
						"method": "GET",
						"header": [],
						"url": {
							"raw": "{{base_url}}/api/asientos/evento/{{evento_id}}",
							"host": [
								"{{base_url}}"
							],
							"path": [
								"api",
								"asientos",
								"evento",
								"{{evento_id}}"
							]
						},
						"description": "Obtiene el mapa de asientos para un evento espec√≠fico, mostrando el estado de cada asiento (disponible, bloqueado, ocupado)."
					},
					"response": []
				},
				{
					"name": "Bloquear Asientos",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"pm.test(\"Status code is 200\", function () {",
									"    pm.response.to.have.status(200);",
									"});",
									"",
									"pm.test(\"Response has bloqueo info\", function () {",
									"    var jsonData = pm.response.json();",
									"    pm.expect(jsonData).to.be.an('object');",
									"});"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"auth": {
							"type": "bearer",
							"bearer": [
								{
									"key": "token",
									"value": "{{admin_token}}",
									"type": "string"
								}
							]
						},
						"method": "POST",
						"header": [],
						"url": {
							"raw": "{{base_url}}/api/asientos/bloquear/{{evento_id}}",
							"host": [
								"{{base_url}}"
							],
							"path": [
								"api",
								"asientos",
								"bloquear",
								"{{evento_id}}"
							]
						},
						"description": "Bloquea temporalmente los asientos seleccionados en la sesi√≥n del usuario para un evento espec√≠fico."
					},
					"response": []
				}
			],
			"description": "Endpoints para gestionar asientos de eventos en el backend."
		},
		{
			"name": "4.1. Asientos (Proxy - Puerto 8081)",
			"item": [
				{
					"name": "Obtener Mapa de Asientos (Proxy)",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"pm.test(\"Status code is 200\", function () {",
									"    pm.response.to.have.status(200);",
									"});",
									"",
									"pm.test(\"Response has mapa structure\", function () {",
									"    var jsonData = pm.response.json();",
									"    pm.expect(jsonData).to.be.an('object');",
									"    pm.expect(jsonData).to.have.property('eventoId');",
									"});"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"auth": {
							"type": "bearer",
							"bearer": [
								{
									"key": "token",
									"value": "{{admin_token}}",
									"type": "string"
								}
							]
						},
						"method": "GET",
						"header": [],
						"url": {
							"raw": "{{proxy_url}}/api/asientos/evento/{{evento_id}}",
							"host": [
								"{{proxy_url}}"
							],
							"path": [
								"api",
								"asientos",
								"evento",
								"{{evento_id}}"
							]
						},
						"description": "Obtiene el mapa de asientos desde el servicio proxy (puerto 8081). El proxy usa Redis para cachear el estado de los asientos."
					},
					"response": []
				},
				{
					"name": "Bloquear Asientos (Proxy)",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"pm.test(\"Status code is 200\", function () {",
									"    pm.response.to.have.status(200);",
									"});",
									"",
									"pm.test(\"Response has bloqueo info\", function () {",
									"    var jsonData = pm.response.json();",
									"    pm.expect(jsonData).to.be.an('object');",
									"    pm.expect(jsonData).to.have.property('exitoso');",
									"});",
									"",
									"// Nota: Este endpoint requiere conexi√≥n al servicio de la c√°tedra (ZeroTier)",
									"if (pm.response.json().exitoso === false) {",
									"    console.log(\"‚ö†Ô∏è Bloqueo fall√≥. Verifica conexi√≥n a ZeroTier y token de c√°tedra.\");",
									"}"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"auth": {
							"type": "bearer",
							"bearer": [
								{
									"key": "token",
									"value": "{{admin_token}}",
									"type": "string"
								}
							]
						},
						"method": "POST",
						"header": [
							{
								"key": "Content-Type",
								"value": "application/json"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "{\n  \"eventoId\": {{evento_id}},\n  \"asientos\": [\n    {\n      \"fila\": \"A\",\n      \"numero\": 1\n    }\n  ]\n}"
						},
						"url": {
							"raw": "{{proxy_url}}/api/asientos/bloquear",
							"host": [
								"{{proxy_url}}"
							],
							"path": [
								"api",
								"asientos",
								"bloquear"
							]
						},
						"description": "Bloquea asientos a trav√©s del servicio proxy. El proxy se comunica con el servicio de la c√°tedra para bloquear los asientos. Requiere conexi√≥n a ZeroTier y token de c√°tedra configurado."
					},
					"response": []
				}
			],
			"description": "Endpoints del servicio proxy (puerto 8081) para gestionar asientos. El proxy usa Redis para cache y se comunica con el servicio de la c√°tedra."
		},
		{
			"name": "5. Administraci√≥n",
			"item": [
				{
					"name": "Verificar Token de C√°tedra",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"pm.test(\"Status code is 200\", function () {",
									"    pm.response.to.have.status(200);",
									"});",
									"",
					"pm.test(\"Response has token status\", function () {",
					"    var jsonData = pm.response.json();",
					"    pm.expect(jsonData).to.have.property('tokenPresent');",
					"    pm.expect(jsonData).to.have.property('baseUrl');",
					"    ",
					"    // Guardar baseUrl autom√°ticamente si est√° presente",
					"    if (jsonData.baseUrl) {",
					"        pm.environment.set(\"catedra_base_url\", jsonData.baseUrl);",
					"    }",
					"    ",
					"    console.log(\"Token presente:\", jsonData.tokenPresent);",
					"    console.log(\"Base URL:\", jsonData.baseUrl);",
					"    ",
					"    if (!jsonData.tokenPresent) {",
					"        console.log(\"‚ö†Ô∏è No hay token configurado. Ejecuta 'Registrar Backend en C√°tedra' y luego 'Actualizar Token de C√°tedra'\");",
					"    }",
					"});"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"auth": {
							"type": "bearer",
							"bearer": [
								{
									"key": "token",
									"value": "{{admin_token}}",
									"type": "string"
								}
							]
						},
						"method": "GET",
						"header": [],
						"url": {
							"raw": "{{base_url}}/api/admin/catedra-token",
							"host": [
								"{{base_url}}"
							],
							"path": [
								"api",
								"admin",
								"catedra-token"
							]
						},
						"description": "Verifica el estado del token de autenticaci√≥n con el servicio de la c√°tedra. Requiere rol ADMIN."
					},
					"response": []
				},
				{
					"name": "Actualizar Token de C√°tedra",
					"event": [
						{
							"listen": "prerequest",
							"script": {
								"exec": [
									"// Si hay un token de c√°tedra guardado, usarlo autom√°ticamente",
									"var catedraToken = pm.environment.get(\"catedra_token\");",
									"if (catedraToken) {",
									"    var body = JSON.parse(pm.request.body.raw);",
									"    body.token = catedraToken;",
									"    pm.request.body.raw = JSON.stringify(body);",
									"    console.log(\"‚úÖ Usando token de c√°tedra guardado autom√°ticamente\");",
									"} else {",
									"    console.log(\"‚ö†Ô∏è No hay token de c√°tedra guardado. Usa el token recibido del registro.\");",
									"}"
								],
								"type": "text/javascript"
							}
						},
						{
							"listen": "test",
							"script": {
								"exec": [
									"pm.test(\"Status code is 204\", function () {",
									"    pm.response.to.have.status(204);",
									"});",
									"",
									"console.log(\"‚úÖ Token de c√°tedra actualizado en el backend\");",
									"console.log(\"üí° Ahora puedes ejecutar 'Sincronizar Eventos desde C√°tedra'\");"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"auth": {
							"type": "bearer",
							"bearer": [
								{
									"key": "token",
									"value": "{{admin_token}}",
									"type": "string"
								}
							]
						},
						"method": "PUT",
						"header": [
							{
								"key": "Content-Type",
								"value": "application/json"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "{\n  \"token\": \"{{catedra_token}}\"\n}"
						},
						"url": {
							"raw": "{{base_url}}/api/admin/catedra-token",
							"host": [
								"{{base_url}}"
							],
							"path": [
								"api",
								"admin",
								"catedra-token"
							]
						},
						"description": "Actualiza el token de autenticaci√≥n con el servicio de la c√°tedra. Requiere rol ADMIN."
					},
					"response": []
				},
				{
					"name": "Eliminar Token de C√°tedra",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"pm.test(\"Status code is 204\", function () {",
									"    pm.response.to.have.status(204);",
									"});"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"auth": {
							"type": "bearer",
							"bearer": [
								{
									"key": "token",
									"value": "{{admin_token}}",
									"type": "string"
								}
							]
						},
						"method": "DELETE",
						"header": [],
						"url": {
							"raw": "{{base_url}}/api/admin/catedra-token",
							"host": [
								"{{base_url}}"
							],
							"path": [
								"api",
								"admin",
								"catedra-token"
							]
						},
						"description": "Elimina el token de autenticaci√≥n con el servicio de la c√°tedra. Requiere rol ADMIN."
					},
					"response": []
				},
				{
					"name": "Acceso a Token Sin Ser Admin (Error 403)",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"pm.test(\"Status code is 403\", function () {",
									"    pm.response.to.have.status(403);",
									"});"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"auth": {
							"type": "bearer",
							"bearer": [
								{
									"key": "token",
									"value": "{{user_token}}",
									"type": "string"
								}
							]
						},
						"method": "GET",
						"header": [],
						"url": {
							"raw": "{{base_url}}/api/admin/catedra-token",
							"host": [
								"{{base_url}}"
							],
							"path": [
								"api",
								"admin",
								"catedra-token"
							]
						},
						"description": "Verifica que los endpoints de administraci√≥n requieren rol ADMIN."
					},
					"response": []
				},
				{
					"name": "Listar Usuarios (Admin)",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"pm.test(\"Status code is 200\", function () {",
									"    pm.response.to.have.status(200);",
									"});",
									"",
									"pm.test(\"Response is an array\", function () {",
									"    var jsonData = pm.response.json();",
									"    pm.expect(jsonData).to.be.an('array');",
									"});"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"auth": {
							"type": "bearer",
							"bearer": [
								{
									"key": "token",
									"value": "{{admin_token}}",
									"type": "string"
								}
							]
						},
						"method": "GET",
						"header": [],
						"url": {
							"raw": "{{base_url}}/api/admin/users?page=0&size=20&sort=id,asc",
							"host": [
								"{{base_url}}"
							],
							"path": [
								"api",
								"admin",
								"users"
							],
							"query": [
								{
									"key": "page",
									"value": "0"
								},
								{
									"key": "size",
									"value": "20"
								},
								{
									"key": "sort",
									"value": "id,asc"
								}
							]
						},
						"description": "Obtiene la lista de usuarios del sistema. Requiere rol ADMIN."
					},
					"response": []
				},
				{
					"name": "Health Check",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"pm.test(\"Status code is 200\", function () {",
									"    pm.response.to.have.status(200);",
									"});",
									"",
									"pm.test(\"All services are UP\", function () {",
									"    var jsonData = pm.response.json();",
									"    pm.expect(jsonData.status).to.equal(\"UP\");",
									"});"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "GET",
						"header": [],
						"url": {
							"raw": "{{base_url}}/management/health",
							"host": [
								"{{base_url}}"
							],
							"path": [
								"management",
								"health"
							]
						},
						"description": "Verifica el estado de salud de la aplicaci√≥n y sus servicios dependientes."
					},
					"response": []
				},
				{
					"name": "M√©tricas",
					"request": {
						"auth": {
							"type": "bearer",
							"bearer": [
								{
									"key": "token",
									"value": "{{admin_token}}",
									"type": "string"
								}
							]
						},
						"method": "GET",
						"header": [],
						"url": {
							"raw": "{{base_url}}/management/metrics",
							"host": [
								"{{base_url}}"
							],
							"path": [
								"management",
								"metrics"
							]
						},
						"description": "Obtiene las m√©tricas de la aplicaci√≥n (JVM, HTTP, base de datos, etc.). Requiere rol ADMIN."
					},
					"response": []
				},
				{
					"name": "Sincronizar Eventos desde C√°tedra",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
					"pm.test(\"Status code is 200\", function () {",
					"    pm.response.to.have.status(200);",
					"});",
					"",
					"console.log(\"‚úÖ Eventos sincronizados desde la c√°tedra\");",
					"console.log(\"üí° Ahora ejecuta 'Listar Eventos Activos' para ver los eventos sincronizados\");"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"auth": {
							"type": "bearer",
							"bearer": [
								{
									"key": "token",
									"value": "{{admin_token}}",
									"type": "string"
								}
							]
						},
						"method": "POST",
						"header": [],
						"url": {
							"raw": "{{base_url}}/api/admin/eventos/sincronizar",
							"host": [
								"{{base_url}}"
							],
							"path": [
								"api",
								"admin",
								"eventos",
								"sincronizar"
							]
						},
						"description": "Sincroniza todos los eventos desde el servicio de la c√°tedra. Requiere rol ADMIN y token de c√°tedra configurado. Este endpoint obtiene los eventos del servicio externo y los guarda/actualiza en la base de datos local."
					},
					"response": []
				}
			],
			"description": "Endpoints de administraci√≥n. Requieren rol ADMIN."
		},
		{
			"name": "6. Integraci√≥n C√°tedra",
			"item": [
				{
					"name": "Registrar Backend en C√°tedra",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"pm.test(\"Status code is 200 or 201\", function () {",
									"    pm.expect(pm.response.code).to.be.oneOf([200, 201]);",
									"});",
									"",
					"// Si la respuesta incluye el token, guardarlo autom√°ticamente",
					"if (pm.response.code === 200 || pm.response.code === 201) {",
					"    try {",
					"        var jsonData = pm.response.json();",
					"        if (jsonData.token) {",
					"            pm.environment.set(\"catedra_token\", jsonData.token);",
					"            // Tambi√©n actualizar el token en el backend autom√°ticamente",
					"            console.log(\"‚úÖ Token de c√°tedra recibido: \" + jsonData.token.substring(0, 20) + \"...\");",
					"            console.log(\"üí° Ejecuta 'Actualizar Token de C√°tedra' para configurarlo en el backend\");",
					"        }",
					"    } catch (e) {",
					"        console.log(\"No se pudo parsear la respuesta como JSON\");",
					"    }",
					"}"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "POST",
						"header": [
							{
								"key": "Content-Type",
								"value": "application/json"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "{\n  \"username\": \"emicoratolo\",\n  \"password\": \"emi123\",\n  \"firstName\": \"Emiliano\",\n  \"lastName\": \"Coratollo\",\n  \"email\": \"e.coratolo@alumno.um.edu.ar\",\n  \"nombreAlumno\": \"Emiliano Coratollo\",\n  \"descripcionProyecto\": \"Proyecto de Emiliano Coratollo\"\n}"
						},
						"url": {
							"raw": "{{catedra_base_url}}/api/v1/agregar_usuario",
							"host": [
								"{{catedra_base_url}}"
							],
							"path": [
								"api",
								"v1",
								"agregar_usuario"
							]
						},
						"description": "Registra el backend en el servicio de la c√°tedra. Requiere estar conectado a la red ZeroTier. Este endpoint es del servicio externo de la c√°tedra, no del backend local."
					},
					"response": []
				},
				{
					"name": "Recibir Notificaci√≥n de Evento",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"pm.test(\"Status code is 204\", function () {",
									"    pm.response.to.have.status(204);",
									"});"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"auth": {
							"type": "bearer",
							"bearer": [
								{
									"key": "token",
									"value": "{{admin_token}}",
									"type": "string"
								}
							]
						},
						"method": "POST",
						"header": [
							{
								"key": "Content-Type",
								"value": "application/json"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "{\n  \"eventoIdCatedra\": 123,\n  \"tipoCambio\": \"CREADO\"\n}"
						},
						"url": {
							"raw": "{{base_url}}/api/admin/eventos/notificacion",
							"host": [
								"{{base_url}}"
							],
							"path": [
								"api",
								"admin",
								"eventos",
								"notificacion"
							]
						},
						"description": "Recibe una notificaci√≥n del servicio de la c√°tedra sobre cambios en eventos. Requiere rol ADMIN."
					},
					"response": []
				}
			],
			"description": "Endpoints relacionados con la integraci√≥n con el servicio de la c√°tedra."
		}
	],
	"event": [
		{
			"listen": "prerequest",
			"script": {
				"type": "text/javascript",
				"exec": [
					"// Script pre-request a nivel de colecci√≥n",
					"// Autom√°ticamente usa el token guardado para requests autenticados",
					"",
					"// NO aplicar autenticaci√≥n a endpoints de login/register",
					"const url = pm.request.url.toString();",
					"const isAuthEndpoint = url.includes('/api/authenticate') || url.includes('/api/register') || url.includes('/api/activate') || url.includes('/api/account/reset-password/init') || url.includes('/api/account/reset-password/finish');",
					"",
					"if (isAuthEndpoint) {",
					"    // Los endpoints de autenticaci√≥n NO deben tener token",
					"    return;",
					"}",
					"",
					"// Obtener tokens de las variables de entorno",
					"let adminToken = pm.environment.get(\"admin_token\");",
					"let userToken = pm.environment.get(\"user_token\");",
					"let token = adminToken || userToken;",
					"",
					"// Limpiar el token si est√° vac√≠o o es solo espacios",
					"if (token && typeof token === 'string') {",
					"    token = token.trim();",
					"    if (token === '' || token === 'undefined' || token === 'null') {",
					"        token = null;",
					"    }",
					"}",
					"",
					"// Si el request tiene autenticaci√≥n Bearer, actualizar el token autom√°ticamente",
					"if (pm.request.auth && pm.request.auth.type === 'bearer') {",
					"    if (token && token.length > 0) {",
					"        // M√©todo 1: Actualizar el valor del bearer token directamente",
					"        try {",
					"            if (pm.request.auth.bearer && pm.request.auth.bearer.length > 0) {",
					"                pm.request.auth.bearer[0].value = token;",
					"            }",
					"        } catch (e) {",
					"            // Ignorar si no se puede modificar",
					"        }",
					"        ",
					"        // M√©todo 2: Agregar/actualizar header Authorization (m√°s confiable)",
					"        const authHeader = 'Bearer ' + token;",
					"        const existingHeader = pm.request.headers.get('Authorization');",
					"        if (existingHeader) {",
					"            pm.request.headers.upsert({",
					"                key: 'Authorization',",
					"                value: authHeader",
					"            });",
					"        } else {",
					"            pm.request.headers.add({",
					"                key: 'Authorization',",
					"                value: authHeader",
					"            });",
					"        }",
					"        ",
					"        console.log(\"‚úÖ Token aplicado autom√°ticamente (longitud: \" + token.length + \")\");",
					"    } else {",
					"        console.log(\"‚ö†Ô∏è Token no encontrado. Ejecuta primero 'Login Admin' o 'Login User'.\");",
					"        console.log(\"   admin_token: \" + (adminToken ? \"existe (\" + adminToken.length + \" chars)\" : \"vac√≠o\"));",
					"        console.log(\"   user_token: \" + (userToken ? \"existe (\" + userToken.length + \" chars)\" : \"vac√≠o\"));",
					"    }",
					"}",
					"",
					"// Auto-completar base_url si no est√° configurado",
					"if (!pm.environment.get(\"base_url\")) {",
					"    pm.environment.set(\"base_url\", \"http://localhost:8080\");",
					"}"
				]
			}
		},
		{
			"listen": "test",
			"script": {
				"type": "text/javascript",
				"exec": [
					"// Scripts de test a nivel de colecci√≥n",
					"// Estos se ejecutan despu√©s de cada request",
					"",
					"// Si el request fue exitoso y es un login, el token ya se guard√≥ en el test del request",
					"// Aqu√≠ podemos agregar l√≥gica adicional si es necesario"
				]
			}
		}
	],
	"variable": [
		{
			"key": "base_url",
			"value": "http://localhost:8080",
			"type": "string"
		}
	]
}

